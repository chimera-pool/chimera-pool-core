name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  CARGO_TERM_COLOR: always
  GO_VERSION: '1.21'
  NODE_VERSION: '18'
  RUST_VERSION: '1.70'

jobs:
  test-go:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: test_password
          POSTGRES_USER: chimera
          POSTGRES_DB: chimera_pool_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}
    
    - name: Cache Go modules
      uses: actions/cache@v3
      with:
        path: ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-
    
    - name: Download dependencies
      run: go mod download
    
    - name: Run tests
      run: go test -v -race -coverprofile=coverage.out ./...
      env:
        DATABASE_URL: postgres://chimera:test_password@localhost:5432/chimera_pool_test?sslmode=disable
        REDIS_URL: redis://localhost:6379
    
    - name: Check coverage
      run: |
        go tool cover -func=coverage.out
        COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
        echo "Coverage: $COVERAGE%"
        if (( $(echo "$COVERAGE < 90" | bc -l) )); then
          echo "âŒ Coverage below threshold: $COVERAGE% < 90%"
          exit 1
        fi
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.out

  test-rust:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: ${{ env.RUST_VERSION }}
        override: true
        components: rustfmt, clippy
    
    - name: Cache Rust dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/.cargo/registry
          ~/.cargo/git
          target
        key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: |
          ${{ runner.os }}-cargo-
    
    - name: Check formatting
      run: cargo fmt --all -- --check
    
    - name: Run clippy
      run: cargo clippy --all-targets --all-features -- -D warnings
    
    - name: Run tests
      run: cargo test --workspace --verbose
    
    - name: Run property tests
      run: cargo test --workspace --features proptest

  test-frontend:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run tests
      run: npm test -- --coverage --watchAll=false
    
    - name: Check coverage threshold
      run: |
        COVERAGE=$(npm test -- --coverage --watchAll=false --silent | grep "All files" | awk '{print $10}' | sed 's/%//')
        echo "Coverage: $COVERAGE%"
        if (( $(echo "$COVERAGE < 90" | bc -l) )); then
          echo "âŒ Coverage below threshold: $COVERAGE% < 90%"
          exit 1
        fi
    
    - name: Build
      run: npm run build

  security:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}
    
    - name: Run Go security scan
      uses: securecodewarrior/github-action-gosec@master
      with:
        args: './...'
    
    - name: Set up Rust
      uses: actions-rs/toolchain@v1
      with:
        toolchain: ${{ env.RUST_VERSION }}
        override: true
    
    - name: Install cargo-audit
      run: cargo install cargo-audit
    
    - name: Run Rust security audit
      run: cargo audit
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run npm audit
      run: npm audit --audit-level moderate

  quality-gates:
    runs-on: ubuntu-latest
    needs: [test-go, test-rust, test-frontend, security]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Download coverage reports
      uses: actions/download-artifact@v3
      with:
        name: coverage-reports
        path: ./coverage
    
    - name: Validate quality gates
      run: |
        echo "ðŸ” Validating quality gates..."
        
        # Check Go coverage
        if [ -f "coverage.out" ]; then
          GO_COVERAGE=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
          echo "Go coverage: $GO_COVERAGE%"
          if (( $(echo "$GO_COVERAGE < 90" | bc -l) )); then
            echo "âŒ Go coverage below 90%: $GO_COVERAGE%"
            exit 1
          fi
        fi
        
        # Check React coverage
        if [ -f "coverage/lcov.info" ]; then
          # Parse React coverage from lcov.info
          REACT_COVERAGE=$(grep -E "^LF:|^LH:" coverage/lcov.info | awk 'BEGIN{lf=0;lh=0} /^LF:/{lf+=$2} /^LH:/{lh+=$2} END{if(lf>0) print (lh/lf)*100; else print 0}')
          echo "React coverage: $REACT_COVERAGE%"
          if (( $(echo "$REACT_COVERAGE < 90" | bc -l) )); then
            echo "âŒ React coverage below 90%: $REACT_COVERAGE%"
            exit 1
          fi
        fi
        
        echo "âœ… All quality gates passed!"
    
    - name: Generate quality report
      run: |
        echo "# Quality Report" > quality-report.md
        echo "" >> quality-report.md
        echo "## Coverage Summary" >> quality-report.md
        echo "- Go: $(go tool cover -func=coverage.out | grep total | awk '{print $3}' 2>/dev/null || echo 'N/A')" >> quality-report.md
        echo "- Rust: Tests passed âœ…" >> quality-report.md
        echo "- React: Coverage threshold met âœ…" >> quality-report.md
        echo "" >> quality-report.md
        echo "## Security Scan Results" >> quality-report.md
        echo "- Go: No vulnerabilities found âœ…" >> quality-report.md
        echo "- Rust: No vulnerabilities found âœ…" >> quality-report.md
        echo "- Node.js: No high/critical vulnerabilities âœ…" >> quality-report.md
    
    - name: Upload quality report
      uses: actions/upload-artifact@v3
      with:
        name: quality-report
        path: quality-report.md

  integration:
    runs-on: ubuntu-latest
    needs: [test-go, test-rust, test-frontend]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Start test environment
      run: |
        docker-compose -f deployments/docker/docker-compose.dev.yml up -d
        sleep 30  # Wait for services to be ready
    
    - name: Run integration tests
      run: |
        # Integration tests will be implemented here
        echo "Integration tests placeholder"
    
    - name: Cleanup
      run: docker-compose -f deployments/docker/docker-compose.dev.yml down