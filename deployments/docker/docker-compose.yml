version: '3.8'

services:
  # Database services (start first)
  postgres:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: chimera_pool
      POSTGRES_USER: chimera
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-Champions$1956}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-db.sql:/docker-entrypoint-initdb.d/init-db.sql
    ports:
      - "5432:5432"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U chimera -d chimera_pool"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # Main application services
  chimera-pool-api:
    build:
      context: ../..
      dockerfile: deployments/docker/Dockerfile.api
    ports:
      - "8080:8080"
    environment:
      DATABASE_URL: postgres://chimera:${POSTGRES_PASSWORD:-Champions$1956}@postgres:5432/chimera_pool?sslmode=disable
      REDIS_URL: redis://redis:6379/0
      JWT_SECRET: ${JWT_SECRET:-Champions$1956_jwt_secret_chimera_pool_2024}
      ENVIRONMENT: ${ENVIRONMENT:-production}
      PORT: "8080"
      BLOCKDAG_RPC_URL: ${BLOCKDAG_RPC_URL:-https://rpc.awakening.bdagscan.com}
      BLOCKDAG_WALLET_ADDRESS: ${BLOCKDAG_WALLET_ADDRESS:-0xD393798C098FFe3d64d4Ca531158D3562D00b66e}
      SMTP_HOST: ${SMTP_HOST:-smtpout.secureserver.net}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USER: ${SMTP_USER:-reid@blockdaginvestors.com}
      SMTP_PASSWORD: ${SMTP_PASSWORD}
      SMTP_FROM: ${SMTP_FROM:-reid@blockdaginvestors.com}
      RESEND_API_KEY: ${RESEND_API_KEY}
      EMAIL_FROM: ${EMAIL_FROM:-Chimera Pool <onboarding@resend.dev>}
      FRONTEND_URL: ${FRONTEND_URL:-https://206.162.80.230}
      # Litecoin Wallet Configuration for Payouts
      LTC_RPC_URL: http://litecoind:9332
      LTC_RPC_USER: chimera
      LTC_RPC_PASSWORD: ChimeraLTC2024!
      LTC_WALLET_PASSWORD: ${LTC_WALLET_PASSWORD:-}
      LTC_MIN_PAYOUT: ${LTC_MIN_PAYOUT:-1000000}
      LTC_PAYOUT_INTERVAL: ${LTC_PAYOUT_INTERVAL:-60}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  chimera-pool-stratum:
    build:
      context: ../..
      dockerfile: deployments/docker/Dockerfile.stratum
    # Use host networking to capture real miner IPs for geolocation
    # This allows the stratum server to see actual client IPs instead of Docker NAT IPs
    # Ports 3333, 3335, 9091 are exposed directly on host
    network_mode: "host"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock  # Docker socket for health monitor restarts (rw required)
    environment:
      # With host networking, use localhost for services
      DATABASE_URL: postgres://chimera:${POSTGRES_PASSWORD:-Champions$1956}@127.0.0.1:5432/chimera_pool?sslmode=disable
      REDIS_URL: redis://127.0.0.1:6379/0
      STRATUM_PORT: "3333"
      JOB_NEGOTIATION_PORT: "3335"
      BLOCKDAG_RPC_URL: ${BLOCKDAG_RPC_URL:-https://rpc.awakening.bdagscan.com}
      BLOCKDAG_WALLET_ADDRESS: ${BLOCKDAG_WALLET_ADDRESS:-0xD393798C098FFe3d64d4Ca531158D3562D00b66e}
      LITECOIN_RPC_URL: http://127.0.0.1:9332
      LITECOIN_RPC_USER: chimera
      LITECOIN_RPC_PASSWORD: ChimeraLTC2024!
      JOB_NEGOTIATION_ENABLED: "true"
      STRATUM_V2_ENABLED: "true"
      HEALTH_MONITOR_ENABLED: "true"
      HEALTH_AUTO_RESTART: "false"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      litecoind:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "3333"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Web Dashboard (React frontend)
  chimera-pool-web:
    build:
      context: ../..
      dockerfile: deployments/docker/Dockerfile.web
    ports:
      - "3000:80"
    depends_on:
      - chimera-pool-api
    restart: unless-stopped

  # Nginx Reverse Proxy with SSL
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./ssl:/etc/nginx/ssl:ro
    depends_on:
      - chimera-pool-api
      - chimera-pool-web
      - grafana
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget --no-verbose --tries=1 -O /dev/null http://localhost:80/ 2>&1 || exit 0"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Litecoin Node for mining pool
  litecoind:
    image: uphold/litecoin-core:0.21
    ports:
      - "9332:9332"   # RPC port
      - "9333:9333"   # P2P port
    volumes:
      - litecoin_data:/home/litecoin/.litecoin
      - ./litecoin.conf:/home/litecoin/.litecoin/litecoin.conf:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "litecoin-cli", "-rpcuser=chimera", "-rpcpassword=ChimeraLTC2024!", "getblockchaininfo"]
      interval: 60s
      timeout: 30s
      retries: 3
      start_period: 120s

  # Monitoring services
  prometheus:
    image: prom/prometheus:latest
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
      - ./alert_rules.yml:/etc/prometheus/alert_rules.yml
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=200h'
      - '--web.enable-lifecycle'
    restart: unless-stopped

  # Grafana - Visualization dashboards
  grafana:
    image: grafana/grafana:latest
    ports:
      - "3001:3000"
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_PASSWORD:-Champions$1956}
      GF_USERS_ALLOW_SIGN_UP: "false"
      GF_SERVER_ROOT_URL: https://206.162.80.230/grafana
      GF_SERVER_SERVE_FROM_SUB_PATH: "true"
      # Enable iframe embedding for dashboard integration
      GF_SECURITY_ALLOW_EMBEDDING: "true"
      GF_SECURITY_COOKIE_SAMESITE: "none"
      GF_SECURITY_COOKIE_SECURE: "true"
      GF_AUTH_ANONYMOUS_ENABLED: "true"
      GF_AUTH_ANONYMOUS_ORG_ROLE: Viewer
      GF_SECURITY_X_FRAME_OPTIONS: ""
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning
      - ./grafana/dashboards:/var/lib/grafana/dashboards
    depends_on:
      - prometheus
    restart: unless-stopped

  # AlertManager - Alert routing and notifications
  alertmanager:
    image: prom/alertmanager:latest
    ports:
      - "9093:9093"
    volumes:
      - ./alertmanager.yml:/etc/alertmanager/alertmanager.yml
      - alertmanager_data:/alertmanager
    command:
      - '--config.file=/etc/alertmanager/alertmanager.yml'
      - '--storage.path=/alertmanager'
    restart: unless-stopped

volumes:
  postgres_data:
  redis_data:
  prometheus_data:
  litecoin_data:
  grafana_data:
  alertmanager_data:

networks:
  default:
    name: chimera-pool-network